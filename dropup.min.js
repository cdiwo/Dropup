/**
 * HTML5 Based File Uploader Plugin. (Phototype JavaScript)
 * Version: 1.3.1 
 * Description: HTML5 input selected or drop files to mutilpile upload.
 * Author: David Wei <weiguangchun@gmail.com>
 * Copyright: (c)2014-2015 CDIWO Inc. All Copyright Reserved. 
 * Website: https://github.com/cdiwo/Dropup
 * CreateDate: 2014-10-24 15:30
 * UpdateDate: 2015-09-24 23:30
 */
!function(){"use strict";var Dropup=function(container,params){var QUEUED,UPLOADING,CANCELED,ERROR,SUCCESS,defaults,param,du=this;du.version="1.3.0",QUEUED="queued",UPLOADING="uploading",CANCELED="canceled",ERROR="error",SUCCESS="success",defaults={url:null,method:"POST",withCredentials:!1,allowExts:null,fileExtDir:null,maxFiles:null,maxFilesize:256,parallelUploads:2,auto:!0,multi:!0,init:!0,clickable:!0,fileInput:null,txtFileTooBig:"文件上传限制最大为{{maxFilesize}}.",txtInvalidFileType:"不允许的文件类型",txtMaxFilesExceeded:"文件数量超限",txtRemoveTips:"您确定要移除这个文件吗？",txtCancelUploadTips:"您确定要取消上传吗？",onDragHover:function(a){a.stopPropagation(),a.preventDefault(),"dragover"===a.type?this.onDragOver():this.onDragLeave()},onDragOver:function(){},onDragLeave:function(){},onDrop:function(){},onProgress:function(){},onSuccess:function(){},onError:function(){},onCanceled:function(){},onDelete:function(){},onComplete:function(){}};for(param in params)defaults[param]=params[param];if(this.params=defaults||{},this.files=[],this.container=container,"string"==typeof this.container&&(this.container=document.querySelector(this.container)),!this.container||null===this.container.nodeType)throw new Error("Invalid dropup container.");if("string"==typeof this.params.fileInput&&(this.params.fileInput=document.querySelector(this.params.fileInput)),!this.params.fileInput||null===this.params.fileInput.nodeType)throw new Error("Invalid fileInput.");return du.getFilesWithStatus=function(a){var e,d,b=this.files,c=[];for(d=0;d<b.length;d++)e=b[d],e.status===a&&c.push(e);return c},du.getQueuedFiles=function(){return this.getFilesWithStatus(QUEUED)},du.getUploadingFiles=function(){return this.getFilesWithStatus(UPLOADING)},du.getSuccessFiles=function(){return this.getFilesWithStatus(SUCCESS)},du.filter=function(a){var d,c,e,b=[];for(c=0;d=a[c];c++)e=d.name.substring(d.name.lastIndexOf(".")),null==this.params.allowExts||-1!=this.params.allowExts.indexOf(e)?d.size>=1e3*this.params.maxFilesize&&(d.status=ERROR,d.errmsg=this.params.txtFileTooBig.replace("{{maxFilesize}}",Dropup.fileSize(1e3*this.params.maxFilesize))):(d.status=ERROR,d.errmsg=this.params.txtInvalidFileType),b.push(d);return b},du.addFiles=function(a){var b,c,e,d;if(this.params.onDragHover(a),b=a.target.files||a.dataTransfer.files,c=this.filter(b),!this.params.multi&&c.length>1&&(c=[c[0]]),this.params.maxFiles&&this.params.maxFiles<this.files.length+c.length)return alert(this.params.txtMaxFilesExceeded),!1;for(d=0;d<c.length;d++)e=c[d],e.upload={progress:0,total:e.size,bytesSent:0},e.id=Dropup.getId(),e.src=Dropup.getSrc(e),this.files.push(e),e.status!==ERROR?(this.enqueueFile(e),this.params.onDrop(e)):this.params.onError(e,e.errmsg)},du.enqueueFile=function(a){return a.status=QUEUED,this.params.auto?setTimeout(function(a){return function(){return a.processQueue()}}(this),0):void 0},du.processQueue=function(){var c,d,a=this.params.auto?this.params.parallelUploads:10,b=this.getUploadingFiles().length;if(!(b>=a)&&(c=this.getQueuedFiles(),c.length>0))for(d=b;a>d&&c.length;)this.uploadFile(c.shift()),d++},du.uploadComplete=function(file,responseText){try{var json=eval("("+responseText+")");0===json.code?(file.url=json.data.path,this.uploadSuccess(file,"上传成功")):this.uploadError(file,json.message)}catch(_error){this.uploadError(file,"Invalid JSON response from server.")}},du.uploadSuccess=function(a,b){a.status=SUCCESS,this.params.onSuccess(a,b),this.params.auto&&this.processQueue()},du.uploadError=function(a,b){a.status=ERROR,this.params.onError(a,b),this.params.auto&&this.processQueue()},du.uploadFile=function(a){var c,d,b=this;return location.host.indexOf("sitepointstatic")>=0?(b.uploadError(a,"非站点服务器上运行"),void 0):(a.status=UPLOADING,c=new XMLHttpRequest,a.xhr=c,c.open(this.params.method,this.params.url,!0),c.withCredentials=!!this.params.withCredentials,c.upload&&(c.upload.addEventListener("progress",function(c){b.params.onProgress(a,c.loaded,c.total)},!1),c.onreadystatechange=function(){4===c.readyState&&(200===c.status?(b.uploadComplete(a,c.responseText),0===b.getQueuedFiles().length&&0===b.getUploadingFiles().length&&b.params.onComplete()):b.uploadError(a,c.responseText))},d=new FormData,d.append("file",a),c.send(d)),void 0)},du.init=function(){var a=this;this.container.addEventListener("dragover",function(b){a.params.onDragHover(b)},!1),this.container.addEventListener("dragleave",function(b){a.params.onDragHover(b)},!1),this.container.addEventListener("drop",function(b){a.addFiles(b)},!1),this.params.clickable&&this.params.fileInput&&(a.container.addEventListener("click",function(){a.params.fileInput.click()}),a.params.fileInput.addEventListener("change",function(b){a.addFiles(b)},!1)),window.File&&window.FileList&&window.FileReader&&window.Blob||alert("您的浏览器不支持HTML5上传")},du.doUpload=function(){this.processQueue()},du.doDelete=function(a){if(this.params.txtRemoveFileConfirmation&&!window.confirm(this.params.txtRemoveFileConfirmation))return!1;for(var b,c=0;c<this.files.length&&(b=this.files[c]).id!==a;)c++;if(b.status===UPLOADING){if(this.params.txtCancelUploadTips&&!window.confirm(this.params.txtCancelUploadTips))return!1;b.xhr.abort(),this.params.onCanceled(b)}return b.status=CANCELED,this.params.onDelete(b),this.params.auto?this.processQueue():void 0},Dropup.fileSize=function(a){var b;return a>=1e6?(a=Math.round(100*(a/1e6))/100,b="MB"):a>=1e3?(a=Math.round(a/1e3),b="KB"):b="B",a+b},Dropup.getId=function(){var a=(new Date).getTime(),b=Math.random();return.1>b&&(b+=.1),b=Math.round(1e3*b),""+a+b},Dropup.getSrc=function(a){return 0===a.type.indexOf("image")||!a.type&&/\.(?:jpg|png|gif)$/.test(a.name)?Dropup.getImageSrc(a):Dropup.getFileSrc(a)},Dropup.getImageSrc=function(a){var c,b=null;return window.URL.createObjectURL?(b=window.URL.createObjectURL(a),window.URL.revokeObjectURL(a)):window.webkitURL.createObjectURL?b=window.webkitURL.createObjectURL(a):(c=new FileReader,c.onload=function(a){b=a.target.result},c.readAsDataURL(a)),b},Dropup.getFileSrc=function(a){var b=a.name,c=b.substring(b.lastIndexOf(".")+1,b.length),d=["txt","doc","docx","xls","xlsx","ppt","pptx","rar","zip"],e=-1!=d.indexOf(c)?"file_"+c+".jpg":"file_default.jpg";return this.params.fileExtDir?(-1==this.params.fileExtDir.lastIndexOf("/")&&this.params.fileExtDir+"/",this.params.fileExtDir+d):e},this.params.init&&this.init(),du};"function"==typeof define&&define.amd?define(function(){return Dropup}):"undefined"!=typeof module&&module.exports?module.exports=Dropup:("undefined"!=typeof window?window:this).Dropup=Dropup}();