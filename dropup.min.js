/*! Dropup v.1.5.0 - HTML5 Based File Uploader | David Wei <weiguangchun@gmail.com> | https://github.com/cdiwo/Dropup */
!function(){"use strict";var a=function(b,c){var e,f,g,h,i,j,k,l,d=this;d.version="1.5.0",e="queued",f="uploading",g="uploaded",h="canceled",i="error",j="success",k={url:null,method:"POST",multipart_params:{},withCredentials:!1,allowExts:null,maxFilesize:256,maxFiles:null,parallelUploads:2,auto:!0,multi:!0,init:!0,fileInput:null,fileDataName:"file",clickable:!0,usedFastClick:!1,txtFileTooBig:"文件上传限制最大为{{maxFilesize}}.",txtInvalidFileType:"不允许的文件类型",txtMaxFilesExceeded:"最多能上传{{maxFiles}}个文件",txtCancelUploadTips:"您确定要取消上传吗？",onDragOver:function(){},onDragLeave:function(){},onDrop:function(){},onBefore:function(){},onProgress:function(){},onUploaded:function(){},onSuccess:function(){},onError:function(){},onCancel:function(){},onDelete:function(){},onComplete:function(){}};for(l in c)k[l]=c[l];return d.params=k||{},d.files=[],d.container=b,d.fileInput=d.params.fileInput,d.onDragHover=function(a){a.stopPropagation(),a.preventDefault(),"dragover"===a.type?this.params.onDragOver():this.params.onDragLeave()},d.getFilesWithStatus=function(a){var e,d,b=this.files,c=[];for(d=0;d<b.length;d++)e=b[d],e.status===a&&c.push(e);return c},d.getQueuedFiles=function(){return this.getFilesWithStatus(e)},d.getUploadingFiles=function(){return this.getFilesWithStatus(f)},d.getSuccessFiles=function(){return this.getFilesWithStatus(j)},d.filter=function(b){var e,d,f,g,c=[];for(d=0;e=b[d];d++)f=(this.params.allowExts||"").replace(/,/g,"|").replace(/\s/g,""),g=new RegExp("\\.(?:"+f+")$"),null===this.params.allowExts||g.test(e.name.toLowerCase())?e.size>=1e3*this.params.maxFilesize&&(e.status=i,e.errmsg=this.params.txtFileTooBig.replace("{{maxFilesize}}",a.formatSize(1e3*this.params.maxFilesize))):(e.status=i,e.errmsg=this.params.txtInvalidFileType),c.push(e);return c},d.addFiles=function(b){var c,e,g,f;if(this.onDragHover(b),c=b.target.files||b.dataTransfer.files,e=this.filter(c),!this.params.multi&&e.length>1&&(e=[e[0]]),this.params.maxFiles&&this.params.maxFiles<this.files.length+e.length)return alert(this.params.txtMaxFilesExceeded.replace("{{maxFiles}}",this.params.maxFiles)),!1;for(f=0;f<e.length;f++)g=e[f],g.id=a.guid(),g.src=a.getSrc(g),g.percent=0,this.files.push(g),g.status!==i?(this.enqueueFile(g),this.params.onDrop(d,g)):this.params.onError(d,g,g.errmsg)},d.enqueueFile=function(a){return a.status=e,this.params.auto?setTimeout(function(a){return function(){return a.processQueue()}}(this),0):void 0},d.processQueue=function(){var c,d,a=this.params.auto?this.params.parallelUploads:10,b=this.getUploadingFiles().length;if(!(b>=a)&&(c=this.getQueuedFiles(),c.length>0))for(d=b;a>d&&c.length;)this.uploadFile(c.shift()),d++},d.uploadComplete=function(a,b){a.status=g;var c;(c=this.params.onUploaded(d,a,b))&&(c===!0?this.params.onSuccess(d,a,"上传成功"):this.params.onError(d,a,c)),this.params.auto&&this.processQueue()},d.uploadSuccess=function(a,b){a.status=j,this.params.onSuccess(d,a,b),this.params.auto&&this.processQueue()},d.uploadError=function(a,b){a.status=i,this.params.onError(d,a,b),this.params.auto&&this.processQueue()},d.uploadFile=function(a){var b,c,e,g;if(a.status=f,d.params.onBefore(d,a),b=new XMLHttpRequest,a.xhr=b,a.startTime=(new Date).getTime(),b.open(d.params.method,d.params.url,!0),b.withCredentials=!!d.params.withCredentials,b.upload){b.upload.addEventListener("progress",function(b){b.lengthComputable&&(a.speed=(b.loaded/((new Date).getTime()-a.startTime)).toFixed(2)+"KB/s",a.percent=(100*(b.loaded/b.total)).toFixed(2),d.params.onProgress(d,a))},!1),b.addEventListener("load",function(){d.uploadComplete(a,b.responseText),0===d.getQueuedFiles().length&&0===d.getUploadingFiles().length&&d.params.onComplete(d)},!1),b.addEventListener("error",function(){d.uploadError(a,b.responseText)},!1),b.addEventListener("abort",function(){d.params.onCancel(d,a)},!1),c=new FormData,e=d.params.multipart_params;for(g in e)c.append(g,e[g]);c.append(d.params.fileDataName,a),b.send(c)}},d.init=function(){if("string"==typeof d.container&&(d.container=document.querySelector(d.container)),!d.container||null===d.container.nodeType)throw new Error("Invalid dropup container.");if("string"==typeof d.fileInput&&(d.fileInput=document.querySelector(d.fileInput)),!d.fileInput||null===d.fileInput.nodeType){var a=document.createElement("input");a.setAttribute("type","file"),a.setAttribute("accept","image/*"),a.setAttribute("capture","camera"),a.setAttribute("stype","display:none;"),d.fileInput=a}d.container.addEventListener("dragover",function(a){d.onDragHover(a)},!1),d.container.addEventListener("dragleave",function(a){d.onDragHover(a)},!1),d.container.addEventListener("drop",function(a){d.addFiles(a)},!1),d.params.clickable&&d.fileInput&&(d.container.addEventListener("click",function(){d.params.usedFastClick?setTimeout(function(){d.fileInput.click()},1e3):d.fileInput.click()}),d.fileInput.addEventListener("change",function(a){d.addFiles(a)},!1)),window.File&&window.FileList&&window.FileReader&&window.Blob||alert("您的浏览器不支持HTML5上传")},d.start=function(){this.processQueue()},d.delete=function(a){for(var b,c=0;c<this.files.length&&(b=this.files[c]).id!==a;)c++;if(b.status===f){if(this.params.txtCancelUploadTips&&!window.confirm(this.params.txtCancelUploadTips))return!1;b.xhr.abort()}return b.status=h,this.params.onDelete(d,b),this.params.auto?this.processQueue():void 0},d.setOption=function(a,b){function c(a,b){if("multipart_params"==a)for(var c in b)d.params.multipart_params[c]=b[c];else d.params[a]=b}if("object"==typeof a)for(var e in a)c(e,a[e]);else c(a,b)},d.getOption=function(a){return a?d.params[a]:d.params},a.isMobileDevice=function(){var a=navigator.userAgent.toLowerCase();return a.match(/iphone|ipad|ipod|android|symbianos|windows phone/)?!0:!1},a.formatSize=function(a){return a>=1e6?Math.round(a/1e4)/100+"MB":a>=1e3?Math.round(a/10)/100+"KB":a+"B"},a.guid=function(a){var e,d,b="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz1234567890_-",c=b.length;for(a=a||32,d="",e=0;a>e;e++)d+=b.charAt(Math.floor(Math.random()*c));return d},a.getSuffix=function(a){var b=a.lastIndexOf("."),c="";return-1!=b&&(c=a.substring(b)),c},a.getSrc=function(b){return 0===b.type.indexOf("image")||!b.type&&/\.(?:jpg|jpeg|png|gif)$/.test(b.name.toLowerCase())?a.getImageSrc(b):""},a.getImageSrc=function(b){var d,c=null;return a.isMobileDevice()?c="":window.URL.createObjectURL?(c=window.URL.createObjectURL(b),window.URL.revokeObjectURL(b)):window.webkitURL.createObjectURL?c=window.webkitURL.createObjectURL(b):(d=new FileReader,d.onload=function(a){c=a.target.result},d.readAsDataURL(b)),c},d.params.init&&this.init(),d};"function"==typeof define&&define.amd?define(function(){return a}):"undefined"!=typeof module&&module.exports?module.exports=a:("undefined"!=typeof window?window:this).Dropup=a}();
