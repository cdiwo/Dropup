/*! Dropup v.1.5.4 - HTML5 Based File Uploader | David Wei <weiguangchun@gmail.com> | https://github.com/cdiwo/Dropup */
!function(){"use strict";var a=function(b,c){var e,f,g,h,i,j,k,l,d=this;d.version="1.5.2",e="queued",f="uploading",g="uploaded",h="canceled",i="error",j="success",k={url:null,method:"POST",withCredentials:!1,requestHeaders:{},formParams:{},dataType:"text",fileDataName:"file",allowExts:null,allowMimeTypes:null,maxFilesize:256,maxFiles:null,parallelUploads:2,auto:!0,multi:!0,init:!0,fileInput:null,clickable:!0,txtFileTooBig:"文件上传限制最大为{{maxFilesize}}.",txtInvalidFileType:"不允许的文件类型",txtMaxFilesExceeded:"最多能上传{{maxFiles}}个文件",txtCancelUploadTips:"您确定要取消上传吗？",onDragOver:function(){},onDragLeave:function(){},onDrop:function(){},onBefore:function(){},onProgress:function(){},onUploaded:function(){},onSuccess:function(){},onError:function(){},onCancel:function(){},onDelete:function(){},onComplete:function(){}};for(l in c)k[l]=c[l];return d.params=k||{},d.files=[],d.container=b,d.fileInput=d.params.fileInput,d.onDragHover=function(a){a.stopPropagation(),a.preventDefault(),"dragover"===a.type?this.params.onDragOver():this.params.onDragLeave()},d.getFilesWithStatus=function(a){var e,d,b=this.files,c=[];for(d=0;d<b.length;d++)e=b[d],e.status===a&&c.push(e);return c},d.getQueuedFiles=function(){return this.getFilesWithStatus(e)},d.getUploadingFiles=function(){return this.getFilesWithStatus(f)},d.getSuccessFiles=function(){return this.getFilesWithStatus(j)},d.filter=function(b){var e,d,f,g,c=[];for(d=0;e=b[d];d++)f=(this.params.allowExts||"").replace(/,/g,"|").replace(/\s/g,""),g=new RegExp("\\.(?:"+f+")$"),null===this.params.allowExts||g.test(e.name.toLowerCase())?e.size>=1e3*this.params.maxFilesize&&(e.status=i,e.errmsg=this.params.txtFileTooBig.replace("{{maxFilesize}}",a.formatSize(1e3*this.params.maxFilesize))):(e.status=i,e.errmsg=this.params.txtInvalidFileType),c.push(e);return c},d.addFiles=function(b){var c,e,g,f;if(this.onDragHover(b),c=b.target.files||b.dataTransfer.files,e=this.filter(c),!this.params.multi&&e.length>1&&(e=[e[0]]),this.params.maxFiles&&this.params.maxFiles<this.files.length+e.length)return alert(this.params.txtMaxFilesExceeded.replace("{{maxFiles}}",this.params.maxFiles)),!1;for(f=0;f<e.length;f++)g=e[f],g.id=a.guid(),g.src=a.getSrc(g),g.percent=0,this.files.push(g),g.status!==i?(this.enqueueFile(g),this.params.onDrop(d,g)):this.params.onError(d,g,g.errmsg)},d.enqueueFile=function(a){return a.status=e,this.params.auto?setTimeout(function(a){return function(){return a.processQueue()}}(this),0):void 0},d.processQueue=function(){var c,d,a=this.params.auto?this.params.parallelUploads:10,b=this.getUploadingFiles().length;if(!(b>=a)&&(c=this.getQueuedFiles(),c.length>0))for(d=b;a>d&&c.length;)this.uploadFile(c.shift()),d++},d.uploadComplete=function(a,b){a.status=g;var c;(c=this.params.onUploaded(d,a,b))&&(c===!0?this.params.onSuccess(d,a,"上传成功"):this.params.onError(d,a,c)),this.params.auto&&this.processQueue()},d.uploadSuccess=function(a,b){a.status=j,this.params.onSuccess(d,a,b),this.params.auto&&this.processQueue()},d.uploadError=function(a,b){a.status=i,this.params.onError(d,a,b),this.params.auto&&this.processQueue()},d.uploadFile=function(a){var b,c,e,g;if((b=this.params.onBefore(d,a))&&"string"==typeof b)return this.params.onError(d,a,b);c=new XMLHttpRequest,a.xhr=c,a.status=f,a.startTime=(new Date).getTime(),c.open(d.params.method,d.params.url,!0),c.withCredentials=!!d.params.withCredentials;for(e in d.params.requestHeaders)c.setRequestHeader(e,d.params.requestHeaders[e]);c.upload.onprogress=function(b){b.lengthComputable&&(a.speed=(b.loaded/((new Date).getTime()-a.startTime)).toFixed(2)+"KB/s",a.percent=(100*(b.loaded/b.total)).toFixed(2),d.params.onProgress(d,a))},c.onload=function(){var c=this.responseText;"json"===d.params.dataType&&(c=JSON.parse(c)),d.uploadComplete(a,c),0===d.getQueuedFiles().length&&0===d.getUploadingFiles().length&&d.params.onComplete(d)},c.onerror=function(){d.params.onError(d,a,this.statusText)},c.onabort=function(){d.params.onCancel(d,a)},g=new FormData,g.append(d.params.fileDataName,a);for(e in d.params.formParams)g.append(e,d.params.formParams[e]);c.send(g)},d.init=function(){if("string"==typeof d.container&&(d.container=document.querySelector(d.container)),!d.container||null===d.container.nodeType)throw new Error("Invalid dropup container.");"string"==typeof d.fileInput&&(d.fileInput=document.querySelector(d.fileInput)),d.fileInput&&null!==d.fileInput.nodeType||(d.fileInput=function(){var a=document.createElement("input");return a.setAttribute("type","file"),a.setAttribute("accept","image/jpeg,image/jpg,image/png,image/gif"),a.setAttribute("capture","camera"),d.params.multi&&a.setAttribute("multiple","multiple"),d.params.allowMimeTypes&&a.setAttribute("accept",d.params.allowMimeTypes),a}()),d.container.addEventListener("dragover",function(a){d.onDragHover(a)},!1),d.container.addEventListener("dragleave",function(a){d.onDragHover(a)},!1),d.container.addEventListener("drop",function(a){d.addFiles(a)},!1),d.fileInput.addEventListener("change",function(a){d.addFiles(a)},!1),d.fileInput.addEventListener("click",function(a){a.stopPropagation()},!1),d.params.clickable&&d.container.addEventListener("click",function(){d.fileInput.click()}),window.File&&window.FileList&&window.FileReader&&window.Blob||alert("您的浏览器不支持HTML5上传")},d.select=function(){d.fileInput.click()},d.start=function(){this.processQueue()},d.delete=function(a){for(var b,c=0;c<this.files.length&&(b=this.files[c]).id!==a;)c++;if(!b||b.id!==a)return!1;if(b.status===f){if(this.params.txtCancelUploadTips&&!window.confirm(this.params.txtCancelUploadTips))return!1;b.xhr.abort()}return b.status=h,this.params.onDelete(d,b),this.params.auto?this.processQueue():void 0},d.setOption=function(a,b){function c(a,b){if("object"==typeof b)for(var c in b)d.params[a][c]=b[c];else d.params[a]=b}if("object"==typeof a)for(var e in a)c(e,a[e]);else c(a,b)},d.getOption=function(a){return a?this.params[a]:this.params},a.isMobileDevice=function(){var a=navigator.userAgent.toLowerCase();return a.match(/iphone|ipad|ipod|android|symbianos|windows phone/)?!0:!1},a.formatSize=function(a){for(var b,c=["B","KB","MB"];(b=c.shift())&&a>1024;)a/=1024;return("B"===b?a:a.toFixed(2))+b},a.guid=function(a,b){for(var c="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz1234567890_-",d=c.length,e=(b||"du_")+(+new Date).toString(32).toUpperCase(),f=e.length;(a||32)>f;f++)e+=c.charAt(Math.floor(Math.random()*d));return e},a.getSuffix=function(a){return/\.([^.]+)$/.exec(a)?RegExp.$1.toLowerCase():""},a.getSrc=function(b){return 0===b.type.indexOf("image")||!b.type&&/\.(?:jpg|jpeg|png|gif|bmp)$/.test(b.name.toLowerCase())?a.getImageSrc(b):""},a.getImageSrc=function(b){var d,c=null;return a.isMobileDevice()?c="":window.URL.createObjectURL?(c=window.URL.createObjectURL(b),window.URL.revokeObjectURL(b)):window.webkitURL.createObjectURL?c=window.webkitURL.createObjectURL(b):(d=new FileReader,d.onload=function(a){c=a.target.result},d.readAsDataURL(b)),c},d.params.init&&this.init(),d};"function"==typeof define&&define.amd?define(function(){return a}):"undefined"!=typeof module&&module.exports?module.exports=a:("undefined"!=typeof window?window:this).Dropup=a}();