/*! Dropup v.1.4.0 - HTML5 Based File Uploader | David Wei <weiguangchun@gmail.com> | https://github.com/cdiwo/Dropup */
!function(){"use strict";var Dropup=function(container,params){var QUEUED,UPLOADING,CANCELED,ERROR,SUCCESS,defaults,param,du=this;du.version="1.4.0",QUEUED="queued",UPLOADING="uploading",CANCELED="canceled",ERROR="error",SUCCESS="success",defaults={url:null,method:"POST",multipart_params:{},base64:!1,withCredentials:!1,allowExts:null,maxFilesize:256,maxFiles:null,parallelUploads:2,auto:!0,multi:!0,init:!0,debug:!1,fileInput:null,fileDataName:"file",clickable:!0,usedFastClick:!1,txtFileTooBig:"文件上传限制最大为{{maxFilesize}}.",txtInvalidFileType:"不允许的文件类型",txtMaxFilesExceeded:"最多能上传{{maxFiles}}个文件",txtCancelUploadTips:"您确定要取消上传吗？",onDragOver:function(){},onDragLeave:function(){},onDrop:function(){},onProgress:function(){},onSuccess:function(){},onError:function(){},onCanceled:function(){},onDelete:function(){},onComplete:function(){}};for(param in params)defaults[param]=params[param];return du.params=defaults||{},du.files=[],du.container=container,du.fileInput=du.params.fileInput,du.onDragHover=function(a){a.stopPropagation(),a.preventDefault(),"dragover"===a.type?this.params.onDragOver():this.params.onDragLeave()},du.getFilesWithStatus=function(a){var e,d,b=this.files,c=[];for(d=0;d<b.length;d++)e=b[d],e.status===a&&c.push(e);return c},du.getQueuedFiles=function(){return this.getFilesWithStatus(QUEUED)},du.getUploadingFiles=function(){return this.getFilesWithStatus(UPLOADING)},du.getSuccessFiles=function(){return this.getFilesWithStatus(SUCCESS)},du.filter=function(a){var d,c,e,f,b=[];for(c=0;d=a[c];c++)e=(this.params.allowExts||"").replace(/,/g,"|"),f=new RegExp("\\.(?:"+e+")$"),null===this.params.allowExts||f.test(d.name)?d.size>=1e3*this.params.maxFilesize&&(d.status=ERROR,d.errmsg=this.params.txtFileTooBig.replace("{{maxFilesize}}",Dropup.formatSize(1e3*this.params.maxFilesize))):(d.status=ERROR,d.errmsg=this.params.txtInvalidFileType),b.push(d);return b},du.addFiles=function(a){var b,c,e,d;if(this.onDragHover(a),b=a.target.files||a.dataTransfer.files,c=this.filter(b),!this.params.multi&&c.length>1&&(c=[c[0]]),this.params.maxFiles&&this.params.maxFiles<this.files.length+c.length)return alert(this.params.txtMaxFilesExceeded.replace("{{maxFiles}}",this.params.maxFiles)),!1;for(d=0;d<c.length;d++)e=c[d],e.id=Dropup.guid(),e.src=Dropup.getSrc(e),e.percent=0,this.files.push(e),e.status!==ERROR?(this.enqueueFile(e),this.params.onDrop(du,e)):this.params.onError(du,e,e.errmsg)},du.enqueueFile=function(a){return a.status=QUEUED,this.params.auto?setTimeout(function(a){return function(){return a.processQueue()}}(this),0):void 0},du.processQueue=function(){var c,d,a=this.params.auto?this.params.parallelUploads:10,b=this.getUploadingFiles().length;if(!(b>=a)&&(c=this.getQueuedFiles(),c.length>0))for(d=b;a>d&&c.length;)this.uploadFile(c.shift()),d++},du.uploadComplete=function(file,responseText){try{var json=eval("("+responseText+")");0===json.code?(file.url=json.data.url,this.uploadSuccess(file,"上传成功")):this.uploadError(file,json.message)}catch(_error){this.params.debug&&console.log("Response is not valid json."),this.uploadSuccess(file,responseText)}},du.uploadSuccess=function(a,b){a.status=SUCCESS,this.params.onSuccess(du,a,b),this.params.auto&&this.processQueue()},du.uploadError=function(a,b){a.status=ERROR,this.params.onError(du,a,b),this.params.auto&&this.processQueue()},du.uploadFile=function(a){var b,c,d,e;if(a.status=UPLOADING,b=new XMLHttpRequest,a.xhr=b,b.open(du.params.method,du.params.url,!0),b.withCredentials=!!du.params.withCredentials,b.upload){b.upload.addEventListener("progress",function(b){b.lengthComputable&&(a.percent=(100*(b.loaded/b.total)).toFixed(2),du.params.onProgress(du,a))},!1),b.addEventListener("load",function(){du.uploadComplete(a,b.responseText),0===du.getQueuedFiles().length&&0===du.getUploadingFiles().length&&du.params.onComplete(du)},!1),b.addEventListener("error",function(){du.uploadError(a,b.responseText)},!1),b.addEventListener("abort",function(){du.params.onCanceled(du,a)},!1),c=new FormData,d=du.params.multipart_params;for(e in d)c.append(e,d[e]);c.append("file",a),b.send(c)}},du.init=function(){if("string"==typeof du.container&&(du.container=document.querySelector(du.container)),!du.container||null===du.container.nodeType)throw new Error("Invalid dropup container.");if("string"==typeof du.fileInput&&(du.fileInput=document.querySelector(du.fileInput)),!du.fileInput||null===du.fileInput.nodeType){var a=document.createElement("input");a.setAttribute("type","file"),a.setAttribute("accept","image/*"),a.setAttribute("capture","camera"),a.setAttribute("stype","display:none;"),du.fileInput=a}du.container.addEventListener("dragover",function(a){du.onDragHover(a)},!1),du.container.addEventListener("dragleave",function(a){du.onDragHover(a)},!1),du.container.addEventListener("drop",function(a){du.addFiles(a)},!1),du.params.clickable&&du.fileInput&&(du.container.addEventListener("click",function(){du.params.usedFastClick?setTimeout(function(){du.fileInput.click()},1e3):du.fileInput.click()}),du.fileInput.addEventListener("change",function(a){du.addFiles(a)},!1)),window.File&&window.FileList&&window.FileReader&&window.Blob||alert("您的浏览器不支持HTML5上传")},du.start=function(){this.processQueue()},du.delete=function(a){for(var b,c=0;c<this.files.length&&(b=this.files[c]).id!==a;)c++;if(b.status===UPLOADING){if(this.params.txtCancelUploadTips&&!window.confirm(this.params.txtCancelUploadTips))return!1;b.xhr.abort()}return b.status=CANCELED,this.params.onDelete(du,b),this.params.auto?this.processQueue():void 0},du.setOption=function(a,b){function c(a,b){if("multipart_params"==a)for(var c in b)du.params.multipart_params[c]=b[c];else du.params[a]=b}if("object"==typeof a)for(var d in a)c(d,a[d]);else c(a,b)},Dropup.isMobileDevice=function(){var a=navigator.userAgent.toLowerCase();return a.match(/iphone|ipad|ipod|android|symbianos|windows phone/)?!0:!1},Dropup.formatSize=function(a){return a>=1e6?Math.round(a/1e4)/100+"MB":a>=1e3?Math.round(a/10)/100+"KB":a+"B"},Dropup.guid=function(a){var e,d,b="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz1234567890_-",c=b.length;for(a=a||32,d="",e=0;a>e;e++)d+=b.charAt(Math.floor(Math.random()*c));return d},Dropup.getSuffix=function(a){return pos=a.lastIndexOf("."),suffix="",-1!=pos&&(suffix=a.substring(pos)),suffix},Dropup.getSrc=function(a){return 0===a.type.indexOf("image")||!a.type&&/\.(?:jpg|jpeg|png|gif)$/.test(a.name)?Dropup.getImageSrc(a):""},Dropup.getImageSrc=function(a){var c,b=null;return Dropup.isMobileDevice()?b="":window.URL.createObjectURL?(b=window.URL.createObjectURL(a),window.URL.revokeObjectURL(a)):window.webkitURL.createObjectURL?b=window.webkitURL.createObjectURL(a):(c=new FileReader,c.onload=function(a){b=a.target.result},c.readAsDataURL(a)),b},du.params.init&&this.init(),du};"function"==typeof define&&define.amd?define(function(){return Dropup}):"undefined"!=typeof module&&module.exports?module.exports=Dropup:("undefined"!=typeof window?window:this).Dropup=Dropup}();
