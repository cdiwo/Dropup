/**
 * HTML5 Based File Uploader Plugin. (Phototype JavaScript)
 * Version: 1.3.0 
 * Description: HTML5 input selected or drop files to mutilpile upload.
 * Author: David Wei <weiguangchun@gmail.com>
 * Copyright: (c)2014-2015 CDIWO Inc. All Copyright Reserved. 
 * Website: https://github.com/cdiwo/Dropup
 * CreateDate: 2014-10-24 15:30
 * UpdateDate: 2015-09-23 23:15
 */
!function(){"use strict";window.Dropup=function(container,params){var param,du=this;du.version="1.3.0",Dropup.QUEUED="queued",Dropup.UPLOADING="uploading",Dropup.CANCELED="canceled",Dropup.ERROR="error",Dropup.SUCCESS="success",du.params={url:null,method:"POST",withCredentials:!1,allowExts:null,fileExtDir:null,maxFiles:null,maxFilesize:256,parallelUploads:2,auto:!0,multi:!0,init:!0,clickable:!0,fileInput:null,txtFileTooBig:"文件上传限制最大为{{maxFilesize}}.",txtInvalidFileType:"不允许的文件类型",txtMaxFilesExceeded:"文件数量超限",txtRemoveTips:"您确定要移除这个文件吗？",txtCancelUploadTips:"您确定要取消上传吗？",onDragHover:function(a){a.stopPropagation(),a.preventDefault(),"dragover"===a.type?du.params.onDragOver():du.params.onDragLeave()},onDragOver:function(){},onDragLeave:function(){},onDrop:function(){},onProgress:function(){},onSuccess:function(){},onError:function(){},onCanceled:function(){},onDelete:function(){},onComplete:function(){}};for(param in params)du.params[param]=params[param];if(du.files=[],du.container=container,"string"==typeof du.container&&(du.container=document.querySelector(du.container)),!du.container||null===du.container.nodeType)throw new Error("Invalid dropup container.");if("string"==typeof du.params.fileInput&&(du.params.fileInput=document.querySelector(du.params.fileInput)),!du.params.fileInput||null===du.params.fileInput.nodeType)throw new Error("Invalid fileInput.");return du.getFilesWithStatus=function(a){var e,d,b=du.files,c=[];for(d=0;d<b.length;d++)e=b[d],e.status===a&&c.push(e);return c},du.getQueuedFiles=function(){return du.getFilesWithStatus(Dropup.QUEUED)},du.getUploadingFiles=function(){return du.getFilesWithStatus(Dropup.UPLOADING)},du.getSuccessFiles=function(){return du.getFilesWithStatus(Dropup.SUCCESS)},du.filter=function(a){var d,c,e,b=[];for(c=0;d=a[c];c++)e=d.name.substring(d.name.lastIndexOf(".")),null==du.params.allowExts||-1!=du.params.allowExts.indexOf(e)?d.size>=1e3*du.params.maxFilesize&&(d.status=Dropup.ERROR,d.errmsg=du.params.txtFileTooBig.replace("{{maxFilesize}}",Dropup.fileSize(1e3*du.params.maxFilesize))):(d.status=Dropup.ERROR,d.errmsg=du.params.txtInvalidFileType),b.push(d);return b},du.addFiles=function(a){var b,c,e,d;if(du.params.onDragHover(a),b=a.target.files||a.dataTransfer.files,c=du.filter(b),!du.params.multi&&c.length>1&&(c=[c[0]]),du.params.maxFiles&&du.params.maxFiles<du.files.length+c.length)return alert(du.params.txtMaxFilesExceeded),!1;for(d=0;d<c.length;d++)e=c[d],e.upload={progress:0,total:e.size,bytesSent:0},e.id=Dropup.getId(),e.src=Dropup.getSrc(e),du.files.push(e),e.status!==Dropup.ERROR?(du.enqueueFile(e),du.params.onDrop(e)):du.params.onError(e,e.errmsg);return this},du.enqueueFile=function(a){return a.status=Dropup.QUEUED,du.params.auto?setTimeout(function(a){return function(){return a.processQueue()}}(du),0):void 0},du.processQueue=function(){var c,d,a=du.params.auto?du.params.parallelUploads:10,b=du.getUploadingFiles().length;if(!(b>=a)&&(c=du.getQueuedFiles(),c.length>0))for(d=b;a>d&&c.length;)du.uploadFile(c.shift()),d++},du.uploadComplete=function(file,responseText){try{var json=eval("("+responseText+")");0===json.code?(file.url=json.data.path,du.uploadSuccess(file,"上传成功")):du.uploadError(file,json.message)}catch(_error){du.uploadError(file,"Invalid JSON response from server.")}},du.uploadSuccess=function(a,b){a.status=Dropup.SUCCESS,du.params.onSuccess(a,b),du.params.auto&&du.processQueue()},du.uploadError=function(a,b){a.status=Dropup.ERROR,du.params.onError(a,b),du.params.auto&&du.processQueue()},du.uploadFile=function(a){var b,c;return location.host.indexOf("sitepointstatic")>=0?(du.uploadError(a,"非站点服务器上运行"),void 0):(a.status=Dropup.UPLOADING,b=new XMLHttpRequest,a.xhr=b,b.open(du.params.method,du.params.url,!0),b.withCredentials=!!du.params.withCredentials,b.upload&&(b.upload.addEventListener("progress",function(b){du.params.onProgress(a,b.loaded,b.total)},!1),b.onreadystatechange=function(){4===b.readyState&&(200===b.status?(du.uploadComplete(a,b.responseText),0===du.getQueuedFiles().length&&0===du.getUploadingFiles().length&&du.params.onComplete()):du.uploadError(a,b.responseText))},c=new FormData,c.append("file",a),b.send(c)),void 0)},du.init=function(){du.container.addEventListener("dragover",function(a){du.params.onDragHover(a)},!1),du.container.addEventListener("dragleave",function(a){du.params.onDragHover(a)},!1),du.container.addEventListener("drop",function(a){du.addFiles(a)},!1),du.params.clickable&&du.params.fileInput&&(du.container.addEventListener("click",function(){du.params.fileInput.click()}),du.params.fileInput.addEventListener("change",function(a){du.addFiles(a)},!1)),window.File&&window.FileList&&window.FileReader&&window.Blob||alert("您的浏览器不支持HTML5上传")},du.doUpload=function(){du.processQueue()},du.doDelete=function(a){if(du.params.txtRemoveFileConfirmation&&!window.confirm(du.params.txtRemoveFileConfirmation))return!1;for(var b,c=0;c<du.files.length&&(b=du.files[c]).id!==a;)c++;if(b.status===Dropup.UPLOADING){if(du.params.txtCancelUploadTips&&!window.confirm(du.params.txtCancelUploadTips))return!1;b.xhr.abort(),du.params.onCanceled(b)}return b.status=Dropup.CANCELED,du.params.onDelete(b),du.params.auto?du.processQueue():void 0},Dropup.fileSize=function(a){var b;return a>=1e6?(a=Math.round(100*(a/1e6))/100,b="MB"):a>=1e3?(a=Math.round(a/1e3),b="KB"):b="B",a+b},Dropup.getId=function(){var a=(new Date).getTime(),b=Math.random();return.1>b&&(b+=.1),b=Math.round(1e3*b),""+a+b},Dropup.getSrc=function(a){return 0===a.type.indexOf("image")||!a.type&&/\.(?:jpg|png|gif)$/.test(a.name)?Dropup.getImageSrc(a):Dropup.getFileSrc(a)},Dropup.getImageSrc=function(a){var c,b=null;return window.URL.createObjectURL?(b=window.URL.createObjectURL(a),window.URL.revokeObjectURL(a)):window.webkitURL.createObjectURL?b=window.webkitURL.createObjectURL(a):(c=new FileReader,c.onload=function(a){b=a.target.result},c.readAsDataURL(a)),b},Dropup.getFileSrc=function(a){var b=a.name,c=b.substring(b.lastIndexOf(".")+1,b.length),d=["txt","doc","docx","xls","xlsx","ppt","pptx","rar","zip"],e=-1!=d.indexOf(c)?"file_"+c+".jpg":"file_default.jpg";return du.params.fileExtDir?(-1==du.params.fileExtDir.lastIndexOf("/")&&du.params.fileExtDir+"/",du.params.fileExtDir+d):e},du.params.init&&du.init(),du}}();