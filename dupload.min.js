
/*! DImage.js v.1.1.0 - HTML5 Image Resize and Rotate Plugin | David Wei <weiguangchun@gmail.com> | https://github.com/cdiwo/DImage.js */
!function(){"use strict";var a=function(a,b,c){var h,d=this,e="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D",f=window.createObjectURL&&window||window.URL&&URL.revokeObjectURL&&URL||window.webkitURL,g={width:1280,height:1280,quality:90,preserveHeaders:!0,autoCompress:!1,debug:!1};for(h in b)g[h]=b[h];d.opts=g,d.debug=d.opts.debug,d.version="1.1.0",d.init=function(){var b=new Image;b.onload=function(){d._metas||"image/jpeg"!==d.type?d.inited():d.parse(a,function(a,b){a||(d._metas=b),d.inited()})},b.onerror=function(){console.log("image load error")},b.src=f.createObjectURL(a),d.type=a.type,d._img=b},d.inited=function(){d.opts.autoCompress&&d.resize(),c&&c(d)},d.destroy=function(){var a=this._canvas;this._img.onload=null,a&&(a.getContext("2d").clearRect(0,0,a.width,a.height),a.width=a.height=0,this._canvas=null),this._img.src=e,this._img=null},d.dataURL2Blob=function(a){var b,c,d,e,f,g;for(g=a.split(","),b=~g[0].indexOf("base64")?atob(g[1]):decodeURIComponent(g[1]),d=new ArrayBuffer(b.length),c=new Uint8Array(d),e=0;e<b.length;e++)c[e]=b.charCodeAt(e);return f=g[0].split(":")[1].split(";")[0],this.arrayBufferToBlob(d,f)},d.dataURL2ArrayBuffer=function(a){var b,c,d,e;for(e=a.split(","),b=~e[0].indexOf("base64")?atob(e[1]):decodeURIComponent(e[1]),c=new Uint8Array(b.length),d=0;d<b.length;d++)c[d]=b.charCodeAt(d);return c.buffer},d.arrayBufferToBlob=function(a,b){var d,c=window.BlobBuilder||window.WebKitBlobBuilder;return c?(d=new c,d.append(a),d.getBlob(b)):new Blob([a],b?{type:b}:{})},d.getAsBlob=function(){var c,d,e,a=this,b=this._canvas;try{if("image/jpeg"===this.type){if(c=b.toDataURL(this.type,a.opts.quality/100),a.opts.preserveHeaders&&this._metas&&this._metas.imageHead)return d=a.dataURL2ArrayBuffer(c),d=a.updateImageHead(d,this._metas.imageHead),e=a.arrayBufferToBlob(d,this.type)}else c=b.toDataURL(this.type);e=this.dataURL2Blob(c)}catch(f){}return e},d.getAsBase64=function(){var c,a=this,b=this._canvas;return c="image/jpeg"===a.type?b.toDataURL(a.type,a.opts.quality/100):b.toDataURL(a.type)},d.rotate=function(){var a=this._canvas||(this._canvas=document.createElement("canvas")),b=d._metas&&d._metas.orientation?d._metas.orientation:1;return 1!=b&&d._rotate(this._img,a,b),this},d._rotate=function(a,b,c){var e=b.getContext("2d"),f=b.width,g=b.height;switch(b.getAttribute("hasResetWH")||(f=a.width,g=a.height),c){case 6:b.width=g,b.height=f,e.rotate(Math.PI/2),e.drawImage(a,0,-g,f,g);break;case 8:b.width=g,b.height=f,e.rotate(-Math.PI/2),e.drawImage(a,-f,0,f,g);break;case 3:e.rotate(Math.PI),e.drawImage(a,-f,-g,f,g)}d.debug&&console.log("width, height, canvas.width, canvas.height",f,g,b.width,b.height)},d.resize=function(){var a=this._canvas||(this._canvas=document.createElement("canvas")),b=this._img,c=d.opts.width,e=d.opts.height;return d._resize(b,a,c,e),this},d._resize=function(a,b,c,e){var i,j,k,f=b.getContext("2d"),g=a.width,h=a.height;1>=c&&c>0&&(c=g*c),1>=e&&e>0&&(e=h*e),i=Math.min(c/g,e/h),i=Math.min(1,i),j=g*i,k=h*i,d.debug&&console.log("naturalHeight, naturalWidth, w, h",h,g,j,k),b.width=j,b.height=k,b.setAttribute("hasResetWH",!0),f.drawImage(a,0,0,j,k)},d.parse=function(a,b){var c=new FileReader,e=262144;c.onload=function(){b(!1,d._parse(this.result)),c=c.onload=c.onerror=null},c.onerror=function(a){b(a.message),c=c.onload=c.onerror=null},a=a.slice(0,e),c.readAsArrayBuffer(a)},d.readOrientationEXIFData=function(a,b){function c(a,b,c){var e,d="";for(e=b;b+c>e;e++)d+=String.fromCharCode(a.getUint8(e));return d}var e,f,g,k,l,m,h,i,j;if("Exif"!=c(a,b,4))return d.debug&&console.log("Not valid EXIF data! "+c(a,b,4)),!1;if(f=b+6,18761==a.getUint16(f))e=!0;else{if(19789!=a.getUint16(f))return d.debug&&console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;e=!1}if(42!=a.getUint16(f+2,e))return d.debug&&console.log("Not valid TIFF data! (no 0x002A)"),!1;if(g=a.getUint32(f+4,e),8>g)return d.debug&&console.log("Not valid TIFF data! (First offset less than 8)",g),!1;for(h=1,i=f+g,j=a.getUint16(i,e),l=0;j>l;l++)k=i+12*l+2,m=a.getUint16(k,e),"0x0112"==m&&(h=a.getUint16(k+8,e));return h},d._parse=function(a){if(!(a.byteLength<6)){var g,h,b=new DataView(a),c=2,e=b.byteLength-4,f={};if(d.debug&&console.log("Got file of length "+a.byteLength),255!=b.getUint8(0)||216!=b.getUint8(1))return d.debug&&console.log("Not a valid JPEG"),f;if(65496===b.getUint16(0)){for(;e>c&&(g=b.getUint16(c),d.debug&&console.log(g),g>=65504&&65519>=g||65534===g)&&(65505==g&&(d.debug&&console.log("Found 0xFFE1 marker"),f.orientation=d.readOrientationEXIFData(b,c+4)),h=b.getUint16(c+2)+2,!(c+h>b.byteLength));)c+=h;c>6&&(f.imageHead=new Uint8Array(a).subarray(2,c))}return f}},d.updateImageHead=function(a,b){var e,f,c=this._parse(a),d=2;return c.imageHead&&(d+=c.imageHead.byteLength),f=new Uint8Array(a).subarray(d),e=new Uint8Array(b.byteLength+2+f.byteLength),e[0]=255,e[1]=216,e.set(new Uint8Array(b),2),e.set(new Uint8Array(f),b.byteLength+2),e.buffer},d.init()};a.create=function(b,c,d){return new a(b,c,d)},"function"==typeof define&&define.amd?define(function(){return a}):"undefined"!=typeof module&&module.exports?module.exports=a:("undefined"!=typeof window?window:this).DImage=a}();

/*! Dropup v.2.2.0 - HTML5 Based File Uploader Plugin | David Wei <weiguangchun@gmail.com> | https://github.com/cdiwo/Dupload.js */
!function(){"use strict";var a=function(a,b){var e,f,g,h,i,j,k,l,m,d=this;d.version="2.2.0",e="queued",f="processing",g="uploading",h="uploaded",i="canceled",j="error",k="success",l={url:null,method:"POST",withCredentials:!1,header:{},formData:{},dataType:"json",fileVal:"file",fileInput:null,allowExts:null,allowMimeTypes:null,maxFilesize:8192,maxFiles:null,parallelUploads:2,auto:!0,multi:!0,compress:!1,init:!0,clickable:!0,txtFileTooBig:"文件上传限制最大为{{maxFilesize}}.",txtInvalidFileType:"不允许的文件类型",txtMaxFilesExceeded:"最多能上传{{maxFiles}}个文件",txtCancelUploadTips:"您确定要取消上传吗？",onDragOver:function(){},onDragLeave:function(){},onDrop:function(){},onBefore:function(){},onProgress:function(){},onUploaded:function(){},onSuccess:function(){},onError:function(){},onCancel:function(){},onDelete:function(){},onComplete:function(){}};for(m in b)l[m]=b[m];return d.params=l||{},d.files=[],d.container=a,d.fileInput=d.params.fileInput,d.onDragHover=function(a){a.stopPropagation(),a.preventDefault(),"dragover"===a.type?this.params.onDragOver():this.params.onDragLeave()},d.getFilesWithStatus=function(a){var d,b=[],c=0;for("string"==typeof a&&(a=a.split(","));d=this.files[c++];)~a.indexOf(d.status)&&b.push(d);return b},d.getQueuedFiles=function(){return this.getFilesWithStatus(e)},d.getUploadingFiles=function(){return this.getFilesWithStatus(g)},d.getSuccessFiles=function(){return this.getFilesWithStatus(k)},d.filter=function(a){for(var g,h,i,b=this.params,d=0,e=[],f={};g=a[d++];)f.source=g,f.name=g.name,f.type=g.type,f.size=g.size,h=(b.allowExts||"").replace(/,/g,"|").replace(/\s/g,""),i=new RegExp("\\.(?:"+h+")$"),null===b.allowExts||i.test(f.name.toLowerCase())?b.maxFilesize&&f.size>=1e3*b.maxFilesize&&(f.status=j,f.errmsg=b.txtFileTooBig.replace("{{maxFilesize}}",c.formatSize(1e3*b.maxFilesize))):(f.status=j,f.errmsg=b.txtInvalidFileType),e.push(f);return e},d.addFiles=function(a){var b,f,i,m,l;if(this.onDragHover(a),b=a.target.files||a.dataTransfer.files,f=this.filter(b),!this.params.multi&&f.length>1&&(f=[f[0]]),i=this.getFilesWithStatus([e,g,h,k]),this.params.maxFiles&&this.params.maxFiles<i.length+f.length)return alert(this.params.txtMaxFilesExceeded.replace("{{maxFiles}}",this.params.maxFiles)),!1;for(l=0;l<f.length;l++)m=f[l],m.id=c.guid(),m.src=c.getSrc(m),m.percent=0,this.files.push(m),m.status!==j?(this.enqueueFile(m),this.params.onDrop(d,m)):this.params.onError(d,m,m.errmsg)},d.enqueueFile=function(a){return a.status=e,this.params.auto?setTimeout(function(a){return function(){return a.processQueue()}}(this),0):void 0},d.processQueue=function(){var c,d,a=this.params.auto?this.params.parallelUploads:10,b=this.getUploadingFiles().length;if(!(b>=a||(c=this.getQueuedFiles(),c.length<=0)))for(d=b;a>d&&c.length;)this.beforeUploadFile(c.shift()),d++},d.uploadComplete=function(a,b){a.status=h;var c;(c=this.params.onUploaded(d,a,b))&&(c===!0?(a.status=k,this.params.onSuccess(d,a,"上传成功")):(a.status=j,this.params.onError(d,a,c))),this.params.auto&&this.processQueue()},d.beforeUploadFile=function(a){var c,b=this.params;return(c=b.onBefore(d,a))&&"string"==typeof c?b.onError(d,a,c):("undefined"!=typeof DImage&&b.compress&&a.type&&~"image/jpeg,image/jpg".indexOf(a.type)&&!a._compressed?(a.status=f,DImage.create(a.source,b.compress,function(b){var c=b.resize().rotate().getAsBlob();a.size=c.size,a.source=c,a.src=b.getAsBase64(),a._compressed=!0,d.uploadFile(a)})):d.uploadFile(a),void 0)},d.uploadFile=function(a){var c,e,b=new XMLHttpRequest;a.xhr=b,a.status=g,a.startTime=(new Date).getTime(),b.open(d.params.method,d.params.url,!0),b.withCredentials=!!d.params.withCredentials;for(c in d.params.header)b.setRequestHeader(c,d.params.header[c]);e=new FormData;for(c in d.params.formData)e.append(c,d.params.formData[c]);e.append(d.params.fileVal,a.source,a.name||""),b.upload.onprogress=function(b){b.lengthComputable&&(a.speed=(b.loaded/((new Date).getTime()-a.startTime)).toFixed(2)+"KB/s",a.percent=(100*(b.loaded/b.total)).toFixed(2),d.params.onProgress(d,a))},b.onload=function(){var c=this.responseText;"json"===d.params.dataType&&(c=JSON.parse(c)),d.uploadComplete(a,c),0===d.getQueuedFiles().length&&0===d.getUploadingFiles().length&&d.params.onComplete(d)},b.onerror=function(){d.params.onError(d,a,this.statusText?this.statusText:"server error")},b.onabort=function(){d.params.onCancel(d,a)},b.send(e)},d.init=function(){if("string"==typeof d.container&&(d.container=document.querySelector(d.container)),!d.container||null===d.container.nodeType)throw new Error("Uploader container invalid!");"string"==typeof d.fileInput&&(d.fileInput=document.querySelector(d.fileInput)),d.fileInput&&null!==d.fileInput.nodeType||(d.fileInput=function(){var a=document.createElement("input");return a.setAttribute("type","file"),a.setAttribute("accept","image/jpeg,image/jpg,image/png,image/gif"),a.setAttribute("capture","camera"),d.params.multi&&a.setAttribute("multiple","multiple"),d.params.allowMimeTypes&&a.setAttribute("accept",d.params.allowMimeTypes),a}()),d.container.addEventListener("dragover",function(a){d.onDragHover(a)},!1),d.container.addEventListener("dragleave",function(a){d.onDragHover(a)},!1),d.container.addEventListener("drop",function(a){d.addFiles(a)},!1),d.fileInput.addEventListener("change",function(a){d.addFiles(a)},!1),d.fileInput.addEventListener("click",function(a){a.stopPropagation()},!1),d.params.clickable&&d.container.addEventListener("click",function(){d.fileInput.click()}),window.File&&window.FileList&&window.FileReader&&window.Blob||alert("您的浏览器不支持HTML5上传")},d.select=function(){d.fileInput.click()},d.start=function(){this.processQueue()},d.delete=function(a){for(var c,b=0;(c=this.files[b++])&&c.id!==a;)continue;if(!c||c.id!==a)return!1;if(c.status===g){if(this.params.txtCancelUploadTips&&!window.confirm(this.params.txtCancelUploadTips))return!1;c.xhr.abort()}return c.status=i,this.params.onDelete(d,c),this.params.auto?this.processQueue():void 0},d.setOption=function(a,b){function c(a,b){if("object"==typeof b)for(var c in b)d.params[a][c]=b[c];else d.params[a]=b}if("object"==typeof a)for(var e in a)c(e,a[e]);else c(a,b)},d.getOption=function(a){return a?this.params[a]:this.params},d.params.init&&this.init(),d},b=window.createObjectURL&&window||window.URL&&URL.revokeObjectURL&&URL||window.webkitURL,c={createObjectURL:b.createObjectURL,revokeObjectURL:b.revokeObjectURL,formatSize:function(a){for(var b,c=["B","KB","MB"];(b=c.shift())&&a>1024;)a/=1024;return("B"===b?a:a.toFixed(2))+b},guid:function(a,b){for(var c="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz1234567890_-",d=c.length,e=(b||"du_")+(+new Date).toString(32).toUpperCase(),f=e.length;f++<(a||32);)e+=c.charAt(Math.floor(Math.random()*d));return e},getSuffix:function(a){return/\.([^.]+)$/.exec(a)?RegExp.$1.toLowerCase():""},getSrc:function(a){return 0===a.type.indexOf("image")||!a.type&&/\.(?:jpg|jpeg|png|gif|bmp)$/.test(a.name.toLowerCase())?c.createObjectURL(a.source):""}};a.create=function(b,c){return"object"==typeof b&&(c=b,b=c.container),new a(b,c)},"function"==typeof define&&define.amd?define(function(){return a}):"undefined"!=typeof module&&module.exports?module.exports=a:("undefined"!=typeof window?window:this).Dupload=a}();
