/*! Dropup v.2.1.0 - HTML5 Based File Uploader Plugin | David Wei <weiguangchun@gmail.com> | https://github.com/cdiwo/Dupload.js */
!function(){"use strict";var a=function(a,b){var f,g,h,i,j,k,l,m,e=this;e.version="2.1.0",f="queued",g="uploading",h="uploaded",i="canceled",j="error",k="success",l={url:null,method:"POST",withCredentials:!1,header:{},formData:{},dataType:"json",fileVal:"file",fileInput:null,allowExts:null,allowMimeTypes:null,maxFilesize:8192,maxFiles:null,parallelUploads:2,auto:!0,multi:!0,compress:0,init:!0,clickable:!0,txtFileTooBig:"文件上传限制最大为{{maxFilesize}}.",txtInvalidFileType:"不允许的文件类型",txtMaxFilesExceeded:"最多能上传{{maxFiles}}个文件",txtCancelUploadTips:"您确定要取消上传吗？",onDragOver:function(){},onDragLeave:function(){},onDrop:function(){},onBefore:function(){},onProgress:function(){},onUploaded:function(){},onSuccess:function(){},onError:function(){},onCancel:function(){},onDelete:function(){},onComplete:function(){}};for(m in b)l[m]=b[m];return e.params=l||{},e.files=[],e.container=a,e.fileInput=e.params.fileInput,e.onDragHover=function(a){a.stopPropagation(),a.preventDefault(),"dragover"===a.type?this.params.onDragOver():this.params.onDragLeave()},e.getFilesWithStatus=function(a){var d,b=[],c=0;for("string"==typeof a&&(a=a.split(","));d=this.files[c++];)~a.indexOf(d.status)&&b.push(d);return b},e.getQueuedFiles=function(){return this.getFilesWithStatus(f)},e.getUploadingFiles=function(){return this.getFilesWithStatus(g)},e.getSuccessFiles=function(){return this.getFilesWithStatus(k)},e.filter=function(a){for(var g,h,i,b=this.params,d=0,e=[],f={};g=a[d++];)f.source=g,f.name=g.name,f.type=g.type,f.size=g.size,h=(b.allowExts||"").replace(/,/g,"|").replace(/\s/g,""),i=new RegExp("\\.(?:"+h+")$"),null===b.allowExts||i.test(f.name.toLowerCase())?b.maxFilesize&&f.size>=1e3*b.maxFilesize&&(f.status=j,f.errmsg=b.txtFileTooBig.replace("{{maxFilesize}}",c.formatSize(1e3*b.maxFilesize))):(f.status=j,f.errmsg=b.txtInvalidFileType),e.push(f);return e},e.addFiles=function(a){var b,d,i,m,l;if(this.onDragHover(a),b=a.target.files||a.dataTransfer.files,d=this.filter(b),!this.params.multi&&d.length>1&&(d=[d[0]]),i=this.getFilesWithStatus([f,g,h,k]),this.params.maxFiles&&this.params.maxFiles<i.length+d.length)return alert(this.params.txtMaxFilesExceeded.replace("{{maxFiles}}",this.params.maxFiles)),!1;for(l=0;l<d.length;l++)m=d[l],m.id=c.guid(),m.src=c.getSrc(m),m.percent=0,this.files.push(m),m.status!==j?(this.enqueueFile(m),this.params.onDrop(e,m)):this.params.onError(e,m,m.errmsg)},e.enqueueFile=function(a){return a.status=f,this.params.auto?setTimeout(function(a){return function(){return a.processQueue()}}(this),0):void 0},e.processQueue=function(){var c,d,a=this.params.auto?this.params.parallelUploads:10,b=this.getUploadingFiles().length;if(!(b>=a||(c=this.getQueuedFiles(),c.length<=0)))for(d=b;a>d&&c.length;)this.beforeUploadFile(c.shift()),d++},e.uploadComplete=function(a,b){a.status=h;var c;(c=this.params.onUploaded(e,a,b))&&(c===!0?(a.status=k,this.params.onSuccess(e,a,"上传成功")):(a.status=j,this.params.onError(e,a,c))),this.params.auto&&this.processQueue()},e.beforeUploadFile=function(a){var c,b=this.params;return(c=b.onBefore(e,a))&&"string"==typeof c?b.onError(e,a,c):(b.compress&&~"image/jpeg,image/jpg".indexOf(a.type)&&!a._compressed?d.resize(a,b.compress,function(){e.uploadFile(a)}):e.uploadFile(a),void 0)},e.uploadFile=function(a){var c,d,b=new XMLHttpRequest;a.xhr=b,a.status=g,a.startTime=(new Date).getTime(),b.open(e.params.method,e.params.url,!0),b.withCredentials=!!e.params.withCredentials;for(c in e.params.header)b.setRequestHeader(c,e.params.header[c]);d=new FormData;for(c in e.params.formData)d.append(c,e.params.formData[c]);d.append(e.params.fileVal,a.source,a.name||""),b.upload.onprogress=function(b){b.lengthComputable&&(a.speed=(b.loaded/((new Date).getTime()-a.startTime)).toFixed(2)+"KB/s",a.percent=(100*(b.loaded/b.total)).toFixed(2),e.params.onProgress(e,a))},b.onload=function(){var c=this.responseText;"json"===e.params.dataType&&(c=JSON.parse(c)),e.uploadComplete(a,c),0===e.getQueuedFiles().length&&0===e.getUploadingFiles().length&&e.params.onComplete(e)},b.onerror=function(){e.params.onError(e,a,this.statusText?this.statusText:"server error")},b.onabort=function(){e.params.onCancel(e,a)},b.send(d)},e.init=function(){if("string"==typeof e.container&&(e.container=document.querySelector(e.container)),!e.container||null===e.container.nodeType)throw new Error("Uploader container invalid!");"string"==typeof e.fileInput&&(e.fileInput=document.querySelector(e.fileInput)),e.fileInput&&null!==e.fileInput.nodeType||(e.fileInput=function(){var a=document.createElement("input");return a.setAttribute("type","file"),a.setAttribute("accept","image/jpeg,image/jpg,image/png,image/gif"),a.setAttribute("capture","camera"),e.params.multi&&a.setAttribute("multiple","multiple"),e.params.allowMimeTypes&&a.setAttribute("accept",e.params.allowMimeTypes),a}()),e.container.addEventListener("dragover",function(a){e.onDragHover(a)},!1),e.container.addEventListener("dragleave",function(a){e.onDragHover(a)},!1),e.container.addEventListener("drop",function(a){e.addFiles(a)},!1),e.fileInput.addEventListener("change",function(a){e.addFiles(a)},!1),e.fileInput.addEventListener("click",function(a){a.stopPropagation()},!1),e.params.clickable&&e.container.addEventListener("click",function(){e.fileInput.click()}),window.File&&window.FileList&&window.FileReader&&window.Blob||alert("您的浏览器不支持HTML5上传")},e.select=function(){e.fileInput.click()},e.start=function(){this.processQueue()},e.delete=function(a){for(var c,b=0;(c=this.files[b++])&&c.id!==a;)continue;if(!c||c.id!==a)return!1;if(c.status===g){if(this.params.txtCancelUploadTips&&!window.confirm(this.params.txtCancelUploadTips))return!1;c.xhr.abort()}return c.status=i,this.params.onDelete(e,c),this.params.auto?this.processQueue():void 0},e.setOption=function(a,b){function c(a,b){if("object"==typeof b)for(var c in b)e.params[a][c]=b[c];else e.params[a]=b}if("object"==typeof a)for(var d in a)c(d,a[d]);else c(a,b)},e.getOption=function(a){return a?this.params[a]:this.params},e.params.init&&this.init(),e},b=window.createObjectURL&&window||window.URL&&URL.revokeObjectURL&&URL||window.webkitURL,c={createObjectURL:b.createObjectURL,revokeObjectURL:b.revokeObjectURL,formatSize:function(a){for(var b,c=["B","KB","MB"];(b=c.shift())&&a>1024;)a/=1024;return("B"===b?a:a.toFixed(2))+b},guid:function(a,b){for(var c="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz1234567890_-",d=c.length,e=(b||"du_")+(+new Date).toString(32).toUpperCase(),f=e.length;f++<(a||32);)e+=c.charAt(Math.floor(Math.random()*d));return e},getSuffix:function(a){return/\.([^.]+)$/.exec(a)?RegExp.$1.toLowerCase():""},getSrc:function(a){return 0===a.type.indexOf("image")||!a.type&&/\.(?:jpg|jpeg|png|gif|bmp)$/.test(a.name.toLowerCase())?c.createObjectURL(a.source):""}},d=function(a,b,c){var g,d=this,e="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D",f={width:1280,height:1280,quality:90,preserveHeaders:!0};for(g in b)f[g]=b[g];d.opts=f,d.debug=!1,d.init=function(){var b=new Image;b.onload=function(){d._metas||"image/jpeg"!==d.type?d.resize(d.opts.width,d.opts.height):d.parse(a.source,function(a,b){d._metas=b,d.resize(d.opts.width,d.opts.height)})},b.onerror=function(){d.trigger("error")},b.src=a.src,d.type=a.type,d._img=b},d.destroy=function(){var a=this._canvas;this._img.onload=null,a&&(a.getContext("2d").clearRect(0,0,a.width,a.height),a.width=a.height=0,this._canvas=null),this._img.src=e,this._img=null},d.dataURL2Blob=function(a){var b,c,d,e,f,g;for(g=a.split(","),b=~g[0].indexOf("base64")?atob(g[1]):decodeURIComponent(g[1]),d=new ArrayBuffer(b.length),c=new Uint8Array(d),e=0;e<b.length;e++)c[e]=b.charCodeAt(e);return f=g[0].split(":")[1].split(";")[0],this.arrayBufferToBlob(d,f)},d.dataURL2ArrayBuffer=function(a){var b,c,d,e;for(e=a.split(","),b=~e[0].indexOf("base64")?atob(e[1]):decodeURIComponent(e[1]),c=new Uint8Array(b.length),d=0;d<b.length;d++)c[d]=b.charCodeAt(d);return c.buffer},d.arrayBufferToBlob=function(a,b){var d,c=window.BlobBuilder||window.WebKitBlobBuilder;return c?(d=new c,d.append(a),d.getBlob(b)):new Blob([a],b?{type:b}:{})},d.getAsBlob=function(){var c,d,e,a=this,b=this._canvas;try{if("image/jpeg"===this.type){if(c=b.toDataURL(this.type,a.opts.quality/100),a.opts.preserveHeaders&&this._metas&&this._metas.imageHead)return d=a.dataURL2ArrayBuffer(c),d=a.updateImageHead(d,this._metas.imageHead),e=a.arrayBufferToBlob(d,this.type),console.log(e),e}else c=b.toDataURL(this.type);e=this.dataURL2Blob(c)}catch(f){}return e},d.resize=function(b,d){var f,e=this._canvas||(this._canvas=document.createElement("canvas"));this._resize(this._img,e,b,d),f=this.getAsBlob(),a.size=f.size,a.source=f,c()},d._resize=function(a,b,c,d){var g,h,i,j,e=a.width,f=a.height;1>=c&&c>0&&(c=e*c),1>=d&&d>0&&(d=f*d),g=Math.min(c/e,d/f),g=Math.min(1,g),h=e*g,i=f*g,b.width=h,b.height=i,j=b.getContext("2d"),j.drawImage(a,0,0,h,i)},d.maxMetaDataSize=262144,d.parse=function(a,b){var c=this,d=new FileReader;d.onload=function(){b(!1,c._parse(this.result)),d=d.onload=d.onerror=null},d.onerror=function(a){b(a.message),d=d.onload=d.onerror=null},a=a.slice(0,c.maxMetaDataSize),d.readAsArrayBuffer(a)},d._parse=function(a){if(!(a.byteLength<6)){var g,h,b=new DataView(a),c=2,e=b.byteLength-4,f={};if(d.debug&&console.log("Got file of length "+a.byteLength),255!=b.getUint8(0)||216!=b.getUint8(1))return d.debug&&console.log("Not a valid JPEG"),f;if(65496===b.getUint16(0)){for(;e>c&&(g=b.getUint16(c),d.debug&&console.log(g),g>=65504&&65519>=g||65534===g)&&(h=b.getUint16(c+2)+2,!(c+h>b.byteLength));)c+=h;c>6&&(f.imageHead=new Uint8Array(a).subarray(2,c))}return f}},d.updateImageHead=function(a,b){var e,f,c=this._parse(a),d=2;return c.imageHead&&(d+=c.imageHead.byteLength),f=new Uint8Array(a).subarray(d),e=new Uint8Array(b.byteLength+2+f.byteLength),e[0]=255,e[1]=216,e.set(new Uint8Array(b),2),e.set(new Uint8Array(f),b.byteLength+2),e.buffer},d.init()};d.resize=function(a,b,c){return new d(a,b,c)},a.create=function(b,c){return"object"==typeof b&&(c=b,b=c.container),new a(b,c)},"function"==typeof define&&define.amd?define(function(){return a}):"undefined"!=typeof module&&module.exports?module.exports=a:("undefined"!=typeof window?window:this).Dupload=a}();
